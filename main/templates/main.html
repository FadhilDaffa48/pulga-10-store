{% extends "base.html" %}
{% block content %}
{% include 'navbar.html' %}
{% load static %}
<title>{{ name }}</title>

<style>
/* === HERO SECTION === */
.hero {
    position: relative;
    height: 80vh;
    background: url("{% static 'image/bg.jpg' %}") no-repeat center center/cover;
}
.hero-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
}
.hero-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    font-size: 3rem;
    font-weight: 800;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.6);
}
.hero-logo {
    width: 80px;
    height: auto;
}
.hero-subtitle {
    font-size: 1.5rem;
    margin: 20px 0;
    text-shadow: 1px 1px 6px rgba(0,0,0,0.6);
}
@media (max-width: 768px) {
    .hero-title { flex-direction: column; font-size: 2rem; }
    .hero-logo { width: 60px; margin: 10px 0; }
    .hero-subtitle { font-size: 1rem; }
    .hero-buttons { flex-direction: column; gap: 10px; align-items: center; }
}
.hero-title, .hero-subtitle, .hero-buttons {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeUp 0.8s ease forwards;
}
.hero-title { animation-delay: 0.2s; }
.hero-subtitle { animation-delay: 0.8s; }
.hero-buttons { animation-delay: 1.4s; }
@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* === PRODUCT SECTION === */
.product-row {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding: 20px 40px;
}
.product-card {
    flex: 0 0 auto;
    width: 220px;
    height: auto;
    display: flex;
    flex-direction: column;
}
.product-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}
.card-body {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    height: auto;
}
.card-description {
    max-height: 40px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
}
.product-actions {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
}
.product-actions button {
    flex: 1;
}
#loading, #empty {
    display: none;
}
</style>

<!-- === HERO === -->
<div class="hero">
  <div class="hero-overlay">
    <h1 class="hero-title">
      <span class="title-part">PULGA</span>
      <img src="{% static 'image/pulga10.png' %}" class="hero-logo">
      <span class="title-part">STORE</span>
    </h1>
    <p class="hero-subtitle">Your Messi Collection Hub</p>
    <div class="hero-buttons">
      <button id="filter-all" class="btn btn-primary px-4">All Products</button>
      <button id="filter-my" class="btn btn-outline-primary px-4">My Products</button>
      <button id="refresh-btn" class="btn btn-outline-info">â†» Refresh</button>
    </div>
  </div>
</div>

<h1 style="text-align:center; padding-top:40px; font-weight:800;">PRODUCTS</h1>

<div id="loading" class="text-center py-4">
  <div class="spinner-border text-primary" role="status"></div>
  <p class="mt-3">Loading products...</p>
</div>

<div id="product-container"></div>

<div id="empty" class="text-center py-5">
  <img src="{% static 'image/empty.png' %}" alt="No Products" style="width:200px;">
  <h3 class="mt-3 fw-bold">No Products Available</h3>
</div>

<!-- === DELETE CONFIRM MODAL === -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p>Are you sure you want to delete this product?</p>
        <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- === EDIT PRODUCT MODAL === -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="productForm">
          {% csrf_token %}
          <input type="hidden" id="product-id">
          <div class="mb-3">
            <label>Name</label>
            <input type="text" id="product-name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Category</label>
            <select id="product-category" class="form-select">
              <option>Shoes</option>
              <option>Jerseys</option>
              <option>Miniatures</option>
              <option>Posters</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Price</label>
            <input type="number" id="product-price" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Description</label>
            <textarea id="product-description" class="form-control"></textarea>
          </div>
          <div class="mb-3">
            <label>Thumbnail URL</label>
            <input type="url" id="product-thumbnail" class="form-control">
          </div>
          <button type="submit" class="btn btn-success w-100">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function getCSRFToken() {
  const cookieValue = document.cookie.split('; ').find(r => r.startsWith('csrftoken='));
  return cookieValue ? cookieValue.split('=')[1] : '';
}

function showToast(message, type = "primary") {
  const toastEl = document.getElementById("liveToast");
  const toastBody = document.getElementById("toast-body");
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  toastBody.textContent = message;
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}

const ENDPOINT = "{% url 'main:show_json' %}";
const container = document.getElementById("product-container");
const loading = document.getElementById("loading");
const empty = document.getElementById("empty");
const btnAll = document.getElementById("filter-all");
const btnMine = document.getElementById("filter-my");

function toggleButtons(active) {
  if (active === "mine") {
    btnMine.classList.add("btn-primary");
    btnMine.classList.remove("btn-outline-primary");
    btnAll.classList.remove("btn-primary");
    btnAll.classList.add("btn-outline-primary");
  } else {
    btnAll.classList.add("btn-primary");
    btnAll.classList.remove("btn-outline-primary");
    btnMine.classList.remove("btn-primary");
    btnMine.classList.add("btn-outline-primary");
  }
}

function renderProducts(data) {
  loading.style.display = "none";
  container.innerHTML = "";

  if (!data.length) {
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  const grouped = {};
  data.forEach(p => {
    const cat = p.category || "Uncategorized";
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(p);
  });

  for (const [category, products] of Object.entries(grouped)) {
    const header = document.createElement("h3");
    header.style.cssText = "padding-top:40px;padding-left:40px;font-weight:800;text-transform:capitalize;";
    header.textContent = category;
    container.appendChild(header);

    const row = document.createElement("div");
    row.className = "product-row";

    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "card product-card";
      card.innerHTML = `
        <img src="${p.thumbnail}" class="card-img-top" alt="${p.name}">
        <div class="card-body">
          <h5 class="card-title text-truncate" title="${p.name}">
            ${p.name}<br>
            <span class="badge bg-secondary">${p.username || "Unknown"}</span>
            <span class="badge bg-success">SOLD: ${p.sold}</span>
            ${p.is_hot ? '<span class="badge bg-danger">HOT</span>' : ''}
          </h5>
          <p class="card-text">$${p.price || 0}</p>
          <p class="card-description">${p.description}</p>
          <a href="/product/${p.id}" class="btn btn-primary w-100">Buy</a>
          ${p.is_owner ? `
            <div class="product-actions mt-2">
              <button class="btn btn-warning btn-sm" onclick="editProduct('${p.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="openDeleteModal('${p.id}')">Delete</button>
            </div>` : ""}
        </div>`;
      row.appendChild(card);
    });
    container.appendChild(row);
  }
}

function loadProducts(filter = "all") {
  toggleButtons(filter);
  loading.style.display = "block";
  container.innerHTML = "";
  empty.style.display = "none";

  fetch(`${ENDPOINT}?filter=${filter}`)
    .then(res => res.json())
    .then(data => renderProducts(data))
    .catch(() => loading.style.display = "none");
}

let deleteId = null;
function openDeleteModal(id) {
  deleteId = id;
  new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
}

document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
  const res = await fetch(`/delete/${deleteId}/`, {   // âœ… CORRECT ENDPOINT
    method: 'POST',
    headers: { 'X-CSRFToken': getCSRFToken() }
  });
  if (res.ok) {
    showToast('ðŸ—‘ï¸ Product deleted!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
    loadProducts();
  } else showToast('âš ï¸ Failed to delete product.', 'danger');
});

async function editProduct(id) {
  const res = await fetch(`/json/${id}/`);
  const data = await res.json();

  document.getElementById('product-id').value = id;
  document.getElementById('product-name').value = data.name;
  document.getElementById('product-category').value = data.category;
  document.getElementById('product-price').value = data.price;
  document.getElementById('product-description').value = data.description;
  document.getElementById('product-thumbnail').value = data.thumbnail;

  new bootstrap.Modal(document.getElementById('productModal')).show();
}

document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('product-id').value;
  const formData = new FormData();
  formData.append('name', document.getElementById('product-name').value);
  formData.append('price', document.getElementById('product-price').value);
  formData.append('category', document.getElementById('product-category').value);
  formData.append('description', document.getElementById('product-description').value);
  formData.append('thumbnail', document.getElementById('product-thumbnail').value);

  const res = await fetch(`/edit/${id}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCSRFToken() },
    body: formData
  });

  if (res.ok) {
    showToast('âœ… Product updated!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    loadProducts();
  } else showToast('âš ï¸ Update failed!', 'danger');
});

document.getElementById('refresh-btn').addEventListener('click', () => {
  loadProducts();
  showToast('ðŸ”„ Product list refreshed!', 'info');
});

btnAll.addEventListener("click", () => loadProducts("all"));
btnMine.addEventListener("click", () => loadProducts("mine"));
document.addEventListener("DOMContentLoaded", () => loadProducts("all"));
</script>
{% endblock content %}
