{% extends "base.html" %}
{% block content %}
<title>Product Detail</title>

<div class="container mt-5">
  <div id="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3">Loading product details...</p>
  </div>

  <div id="product-detail" class="card shadow-lg d-none">
    <div class="row g-0">
      <div class="col-md-5 text-center p-3">
        <img id="prod-img" src="" alt="Product Image" class="img-fluid rounded">
      </div>

      <div class="col-md-7">
        <div class="card-body">
          <h2 id="prod-name" class="card-title fw-bold"></h2>

          <h5 class="mb-3">
            <span id="prod-category" class="badge bg-primary"></span>
            <span id="prod-hot" class="badge bg-danger d-none">HOT</span>
            <span id="prod-username" class="badge bg-secondary"></span>
            <span id="prod-sold" class="badge bg-success"></span>
          </h5>

          <p id="prod-desc" class="card-text"></p>
          <h5 id="prod-price" class="fw-bold text-primary"></h5>

          <div class="d-flex gap-2 mt-4">
            <button id="buy-btn" class="btn btn-success">Buy Product</button>
            <a href="{% url 'main:display' %}" class="btn btn-outline-secondary">
              Go Back
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="liveToast" class="toast align-items-center text-bg-primary border-0" 
       role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-body">
        Message here
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" 
              data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
function getCSRFToken() {
  const cookieValue = document.cookie
    .split("; ")
    .find(row => row.startsWith("csrftoken="));
  return cookieValue ? cookieValue.split("=")[1] : "";
}

document.addEventListener("DOMContentLoaded", async () => {
  const productId = "{{ product.id }}"; 
  const detailDiv = document.getElementById("product-detail");
  const loadingDiv = document.getElementById("loading");

  try {
    const res = await fetch(`/json/${productId}/`);
    const data = await res.json();

    document.getElementById("prod-name").textContent = data.name;
    document.getElementById("prod-img").src = data.thumbnail;
    document.getElementById("prod-category").textContent = data.category;
    document.getElementById("prod-username").textContent = data.user_username;
    document.getElementById("prod-sold").textContent = `SOLD: ${data.sold}`;
    document.getElementById("prod-desc").textContent = data.description;
    document.getElementById("prod-price").textContent = `$${data.price}`;
    if (data.is_hot) document.getElementById("prod-hot").classList.remove("d-none");

    loadingDiv.classList.add("d-none");
    detailDiv.classList.remove("d-none");

  } catch (err) {
    console.error("❌ Error fetching product:", err);
    loadingDiv.innerHTML = "<p class='text-danger fw-bold'>Failed to load product data.</p>";
  }

  document.getElementById("buy-btn").addEventListener("click", async () => {
    const button = document.getElementById("buy-btn");
    button.disabled = true;
    button.textContent = "Processing...";

    try {
      const res = await fetch(`/product/buy/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),   
        },
      });

      if (res.ok) {
        showToast("✅ Purchase successful!", "success");
        location.reload();
      } else {
        showToast("⚠️ Purchase failed!", "danger");
      }
    } catch (err) {
      showToast("❌ Server error occurred!", "danger");
      console.error(err);
    } finally {
      button.disabled = false;
      button.textContent = "Buy Product";
    }
  });
});

function showToast(message, type = "primary") {
  const toastEl = document.getElementById("liveToast");
  const toastBody = document.getElementById("toast-body");

  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  toastBody.textContent = message;

  const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
  toast.show();
}
</script>
{% endblock content %}
