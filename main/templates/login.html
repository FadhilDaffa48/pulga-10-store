{% extends 'base.html' %}

{% block meta %}
<title>Login</title>
{% endblock meta %}

{% block content %}
<div class="container mt-4" style="box-shadow: 2px 2px 5px gray; padding: 50px;">
    <h2 style="text-align: center; font-weight: bold; color: black;">Login</h2>

    <form id="loginForm" method="POST">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.username.label_tag }}
            {{ form.username }}
            {% if form.username.errors %}
                <div class="text-danger small">{{ form.username.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.password.label_tag }}
            {{ form.password }}
            {% if form.password.errors %}
                <div class="text-danger small">{{ form.password.errors }}</div>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-primary w-100">Sign in</button>

        <p class="mt-3 text-center">
            No account yet?
            <a href="{% url 'main:register' %}">Register Now!</a>
        </p>
    </form>

    <div id="loginStatus" class="mt-3 text-center fw-bold"></div>
</div>

{% if messages %}
<div class="container mt-4" style="padding: 20px;">
    {% for message in messages %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<!-- === AJAX SCRIPT === -->
<script>
document.getElementById("loginForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  try {
    const res = await fetch("{% url 'main:login' %}", {
      method: "POST",
      body: formData,
    });

    const data = await res.json();

    if (data.success) {
      showToast("✅ Login berhasil!", "success");
      setTimeout(() => {
        window.location.href = data.redirect_url;
      }, 1000);
    } else {
      showToast(data.error || "❌ Username atau password salah.", "danger");
    }
  } catch (err) {
    console.error("Login error:", err);
    showToast("⚠️ Terjadi kesalahan server.", "warning");
  }
});
</script>


{% endblock content %}
